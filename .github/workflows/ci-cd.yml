name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: rg-emotion-api-v2
  ACR_NAME: mlopsbank5415
  CONTAINER_APP_NAME: bank-churn-api
  IMAGE_NAME: churn-api
  LOCATION: francecentral

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=app --cov-report=term
          
      - name: Lint with flake8
        run: |
          pip install flake8
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || true

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.IMAGE_NAME }}:latest
          echo "‚úÖ Docker image built successfully!"
          
      - name: Test Docker container
        run: |
          # Start container in background
          docker run -d -p 8000:8000 --name test-container ${{ env.IMAGE_NAME }}:latest
          sleep 10
          # Test health endpoint
          curl -f http://localhost:8000/health || exit 1
          echo "‚úÖ Container health check passed!"
          docker stop test-container

  # Deploy job - requires secrets to be configured
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Check secrets configured
        id: check-secrets
        run: |
          if [ -z "${{ secrets.ACR_USERNAME }}" ] || [ -z "${{ secrets.ACR_PASSWORD }}" ]; then
            echo "‚ö†Ô∏è ACR secrets not configured. Skipping deployment."
            echo "configured=false" >> $GITHUB_OUTPUT
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Login to ACR
        if: steps.check-secrets.outputs.configured == 'true'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
          
      - name: Build and Push to ACR
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          echo "‚úÖ Image pushed to ACR!"
          
      - name: Deployment Info
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          echo "üì¶ Image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "üåê API URL: https://bank-churn-api.livelyforest-eec13037.francecentral.azurecontainerapps.io"
          echo ""
          echo "To update Azure Container App manually, run:"
          echo "az containerapp update --name ${{ env.CONTAINER_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}"
